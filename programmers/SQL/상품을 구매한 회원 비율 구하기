WITH TOTAL AS (
  SELECT
    USER_ID,
    COUNT(DISTINCT USER_ID) AS CNT
  FROM USER_INFO
  WHERE JOINED BETWEEN '2021-01-01' AND '2021-12-31'
)
SELECT
  YEAR(O.SALES_DATE) AS YEAR,
  MONTH(O.SALES_DATE) AS MONTH,
  COUNT(DISTINCT O.USER_ID) AS PUCHASED_USERS,
  ROUND(COUNT(DISTINCT CASE WHEN YEAR(U.JOINED) = 2021 THEN O.USER_ID END) / (SELECT CNT FROM TOTAL),1) AS PUCHASED_RATIO
FROM ONLINE_SALE O
  INNER JOIN (SELECT USER_ID, JOINED
              FROM USER_INFO
              WHERE JOINED BETWEEN '2021-01-01' AND '2021-12-31'
              GROUP BY USER_ID
             ) U
    ON O.USER_ID = U.USER_ID
GROUP BY MONTH(O.SALES_DATE)
