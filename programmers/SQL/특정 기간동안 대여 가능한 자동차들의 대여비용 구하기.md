```sql
WITH EXCEPTS AS(
  SELECT
    CAR_ID,
    HISTORY_ID,
    END_DATE
  FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY
  WHERE START_DATE BETWEEN START_DATE AND '2022-11-01'
    AND END_DATE BETWEEN '2022-11-30' AND END_DATE    
)
SELECT
  C.CAR_ID,
  C.CAR_TYPE,
  TRUNCATE((C.DAILY_FEE * ((100 - P.DISCOUNT_RATE) / 100) * 30), 0) AS FEE
FROM CAR_RENTAL_COMPANY_CAR C
  LEFT JOIN (SELECT
              DISCOUNT_RATE,
                CAR_TYPE
              FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
              WHERE CAR_TYPE IN ('세단', 'SUV')
                AND DURATION_TYPE LIKE ('30%')
            ) P
    ON C.CAR_TYPE = P.CAR_TYPE
WHERE C.CAR_ID NOT IN (SELECT CAR_ID FROM EXCEPTS)
  AND TRUNCATE((C.DAILY_FEE * ((100 - P.DISCOUNT_RATE) / 100) * 30), 0) BETWEEN 500000 AND 2000000
ORDER BY FEE DESC, C.CAR_TYPE ASC, C.CAR_ID DESC
```
---
```sql
SELECT
  C.CAR_ID,
  C.CAR_TYPE,
  TRUNCATE((C.DAILY_FEE * ((100 - P.DISCOUNT_RATE) / 100) * 30), 0) AS FEE
FROM CAR_RENTAL_COMPANY_CAR C
  LEFT JOIN (SELECT
              DISCOUNT_RATE,
              CAR_TYPE
             FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
             WHERE CAR_TYPE IN ('세단', 'SUV')
               AND DURATION_TYPE LIKE ('30%')
            ) P
    ON C.CAR_TYPE = P.CAR_TYPE
  LEFT JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY H
    ON C.CAR_ID = H.CAR_ID
WHERE TRUNCATE((C.DAILY_FEE * ((100 - P.DISCOUNT_RATE) / 100) * 30), 0) BETWEEN 500000 AND 2000000
GROUP BY 1 having MAX(H.END_DATE) < '2022-11-01 00:00:00' 
ORDER BY FEE DESC, C.CAR_TYPE ASC, C.CAR_ID DESC
```
